## ETL: Автоматизация подготовки данных

Учебный проект третьего спринта курса Яндекс Практикум "Инженер данных".

В данном репозитории находятся следующие файлы:
- [sprint3.py](https://github.com/IgorGoltsov/portfolio/blob/main/ETL/sprint3.py) - Основной даг ETL процесса
- [DDL_mart.f_scr.sql](https://github.com/IgorGoltsov/portfolio/blob/main/ETL/DDL_mart.f_scr.sql) - SQL скрипт для создания витрины данных по retention
- [sql](https://github.com/IgorGoltsov/portfolio/tree/main/ETL/sql) - папка в которой находятся SQL скрипты для вставки значений в таблицы измерений и фактов из staging слоя
___

### Описание проекта

В рамках данного проекта необходимо было выполнить три задачи: 

1) В интернет магазине был добавлен функционал отмены заказов и возврата средств (refunded). Необходимо обновить процессы в пайплайне, что бы учитывать появление новых столбцов в витрине mart.f_sales. Так же для корректного подсчета total revenue, значение payment_amount в заказах со статусом 'refunded' должно быть с минусом. 
2) Необходимо составить витрину данных по customer retention, которая покажет на еженедельном уровне, какие категории товаров лучше всего удерживают клиентов. Так же настроить пайплайн, для обновления данных в этой витрине. 
3) Обеспечить в пайплайне условия идемпотентности (избежать появления повторов при перезапуске)

___

### Описание столбцов витрины по retention 

mart.f_customer_retention
1. `new_customers_count` — кол-во новых клиентов (тех, которые сделали только один 
заказ за рассматриваемый промежуток времени).
2. 'returning_customers_count' — кол-во вернувшихся клиентов (тех,
которые сделали только несколько заказов за рассматриваемый промежуток времени).
3. 'refunded_customer_count' — кол-во клиентов, оформивших возврат за 
рассматриваемый промежуток времени.
4. 'period_name' — weekly.
5. 'period_id' — идентификатор периода (номер недели или номер месяца).
6. 'item_id' — идентификатор категории товара.
7. 'new_customers_revenue' — доход с новых клиентов.
8. 'returning_customers_revenue' — доход с вернувшихся клиентов.
9. 'customers_refunded' — количество возвратов клиентов.

___

Ход выполнения проекта: 

В первом этапе для того что бы добавить колонку статус, в функции upload_to_staging добавил sql запрос с добавлением колонки. 

Так же добавил запрос на добавление колонки в витрину mart.f_sales непосредственно в sql скрипте mart.f_sales.sql и там же поменял условие для payment_amount, что бы при статусе 'refunded' добавлялся знак минус. 

Во втором этапе DDL запрос на создание витрины лежит отдельно в данном репозитории. В пайплайне sprint3 добавил Postgres  оператор 'update_d_scr' для заполнения витрины mart.f_customer_retention.  

Идемпотентность обеспечена за счёт добавления DELETE FROM запросов. 
